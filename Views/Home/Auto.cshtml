@using RentAutoWeb.Models
@using RentAutoWeb.Extensions

@model List<RentAutoWeb.Models.CarWithRentalStatusViewModel>

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    var userName = Context.Request.Cookies["UserName"] ?? "–ì–æ—Å—Ç—å";
}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ ‚Äì RentAuto</title>
    <link rel="stylesheet" href="/CSS/Index.css" />
    <link rel="stylesheet" href="/CSS/Login.css" />
    <link rel="stylesheet" href="/CSS/Auto.css" />
    <link rel="stylesheet" href="/CSS/Add.css" />
    <link rel="stylesheet" href="/CSS/Rental.css" />
</head>
<body>
    <header>
        <nav class="ContainerNavigation">
            <div class="logo">
                <img src="/MEDIA/Logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø RentAuto" />
            </div>
            <ul class="navigation-menu">
                <li><a asp-controller="Home" asp-action="Index">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="active"><a asp-controller="Home" asp-action="Auto">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</a></li>
                <li><a asp-controller="Home" asp-action="About">–û –Ω–∞—Å</a></li>
                <li><a asp-controller="Home" asp-action="PersonalCabinet">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
                @if (User.Identity.IsAuthenticated && User.IsInRole("Admin"))
                {
                    <li><a asp-controller="Home" asp-action="Admin">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–æ–π</a></li>
                }
            </ul>

            <div class="user-actions">
                    @if (User.Identity != null && User.Identity.IsAuthenticated)
                    {
                        @if (!string.IsNullOrEmpty(userName))
                        {
                            <span class="user-name">@userName</span>
                        }
                        <form method="post" action="/Login/Logout" style="display:inline">
                            <button type="submit" class="modal-button button">–í—ã–π—Ç–∏</button>
                        </form>
                    }
                    else
                    {
                        <span id="user-name" class="user-name" style="display:none"></span>
                        <button id="loginButton" class="modal-button button">–í–æ–π—Ç–∏</button>
                        <button id="logoutButton" class="modal-button button" style="display:none">–í—ã–π—Ç–∏</button>
                    }
                </div>
        </nav>
    </header>

    <main class="cars-container">
        <h2 class="section-title" style="text-align:center; margin-bottom: var(--spacing-lg);">–ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</h2>

        @if (Model != null && Model.Any())
        {
            <div class="cars-grid">
                @foreach (var car in Model)
                {
                    <div class="car-card">
                        <img src="@car.Car.ImageUrl" alt="@car.Car.Brand @car.Car.Model" class="car-image" />
                        <div class="car-info">
                            <h3 class="car-title">@car.Car.Brand @car.Car.Model (@car.Car.Year)</h3>
                            <p class="car-details"><strong>@car.Car.Price</strong> —Ä—É–±./—Å—É—Ç–∫–∏</p>
                            <p class="car-details">
                                <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> @(string.IsNullOrWhiteSpace(car.RecommendationHint) ? "–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π" : car.RecommendationHint)
                            </p>
                            
                            <details>
                                <summary >–ü–æ–¥—Ä–æ–±–Ω–µ–µ</summary>
                                <div class="details-content">
                                <p class="car-details"><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> @car.Car.Category</p>
                                <p class="car-details"><strong>–¶–≤–µ—Ç:</strong> @car.Car.Color</p>
                                <p class="car-details"><strong>–ú–æ—â–Ω–æ—Å—Ç—å –ª.—Å.:</strong> @car.Car.HorsePower</p>
                                <p class="car-details"><strong>–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞:</strong> @car.Car.FuelType</p>
                                <p class="car-details"><strong>–ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á:</strong> @car.Car.TransmissionType</p>
                                <p class="car-details"><strong>–ì–æ–¥:</strong> @car.Car.Year</p>
                                <p class="car-details"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> @car.Car.Description</p>
                                <p class="car-details"><strong>–ù–æ–º–µ—Ä –∞–≤—Ç–æ:</strong> @car.Car.AutoNumber</p>

                                <!-- –ó–¥–µ—Å—å —Ç–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è –¢–û -->
                                @if (car.MaintenanceRecords != null && car.MaintenanceRecords.Any())
                                {
                                    <div class="maintenance-history">
                                        <div class="maintenance-header">
                                            <strong>üìã –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</strong>
                                            <span class="records-count">(@car.MaintenanceRecords.Count() –∑–∞–ø–∏—Å–µ–π)</span>
                                        </div>
                                        
                                        <div class="maintenance-records">
                                            @foreach (var record in car.MaintenanceRecords.OrderByDescending(r => r.MaintenanceDate).Take(3))
                                            {
                                                <div class="maintenance-record">
                                                    <div class="record-date">
                                                        üìÖ @(record.MaintenanceDate.ToString("dd.MM.yyyy") ?? "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
                                                        @(string.IsNullOrEmpty(record.Description) ? "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" : record.Description)
                                                    </div>
                                                </div>
                                            }
                                            
                                            @if (car.MaintenanceRecords.Count() > 3)
                                            {
                                                <div class="more-records">
                                                    <small>–ò –µ—â–µ @(car.MaintenanceRecords.Count() - 3) –∑–∞–ø–∏—Å–µ–π...</small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="no-maintenance">
                                        <div class="no-maintenance-icon">üîß</div>
                                        <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏</p>
                                        <small>–ò—Å—Ç–æ—Ä–∏—è –¢–û –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</small>
                                    </div>
                                }
                                </div>                               
                            </details>
                        </div>
                        <!-- –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                    
                        <div class="car-actions">
                            <a class="card-button show-on-map-btn" 
                            data-lat="@car.Car.Latitude.ToString("F8", System.Globalization.CultureInfo.InvariantCulture)"
                            data-lon="@car.Car.Longitude.ToString("F8", System.Globalization.CultureInfo.InvariantCulture)"
                            data-url="@Url.Action("Index", "Home")">
                                –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                            </a>

                                @if ((car.Rental?.Status == RentalStatus.Active) || (car.Rental?.Status == RentalStatus.PendingPayment))
                                {
                                    <button class="btn btn-secondary" disabled>–ó–∞–Ω—è—Ç</button>
                                }
                                else
                                {
                                    <button class="btn-primary" data-car-id="@car.Car.Id" onclick="openRentalModal(@car.Car.Id)">–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å</button>
                                }
                            
                        </div>

                        <div class="car-actions">
                            @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                            {
                                <button class="open-edit-modal btn-primary" data-id="@car.Car.Id">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            }
                        </div>

                        
                    </div>
                    
                }

            </div>
        }
        else
        {
            <p style="text-align:center">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.</p>
        }

        
    @if (User.IsInRole("Admin"))
    {
        <button type="button" class="modal-button" onclick="openAddCarModal()">–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</button>
    }
        

        <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
        <div class="modal" id="add-car-modal" style="display:none;">
            <div class="modal-content">
                <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
                <span class="close-modal" onclick="closeAddCarModal()">&times;</span>

                <h2>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h2>

                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ -->
                <div id="add-car-success" style="display:none; color:green; margin-bottom: 10px;">
                    –ê–≤—Ç–æ–º–æ–±–∏–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!
                </div>

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (—á–∞—Å—Ç–∏—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ Add.cshtml) -->
                @await Html.PartialAsync("Add", new RentAutoWeb.Models.Car())
            </div>
        </div>

    
    </main>

    <div class="modal" id="login-modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login">Email:</label>
                    <input type="email" id="login" name="login" required />
                </div>
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required />
                </div>
                <button class="modal-button" type="submit">–í–æ–π—Ç–∏</button>
            </form>
            <div id="login-error-messages"></div>
            <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a asp-controller="Registration" asp-action="Registration" id="registration-modal">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –¥–ª—è –∞—Ä–µ–Ω–¥—ã -->
    <div class="modal" id="rental-modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" onclick="closeRentalModal()">&times;</span>
            <div id="rental-form-container">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div class="car-edit-modal" id="car-edit-modal">
        <div class="car-edit-modal-content" id="car-edit-modal-content">
            <span class="car-edit-close" id="car-edit-close">&times;</span>
            <div id="car-edit-form-container" style="clear:both; padding-top:10px;">
                <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ AJAX -->
                <div style="text-align: center; padding: 20px;">
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ä–º—ã...</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        const centerLat = @(ViewBag.CenterLat?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "null");
        const centerLon = @(ViewBag.CenterLon?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "null");
    </script>
    
    <script src="/JS/Index.js"></script>
    <script src="/JS/Modal.js"></script>
    <script src="/JS/EditModal.js"></script>
    <script src="/JS/AddCar.js"></script>
    <script src="/JS/MapInit.js"></script>
    <script src="/JS/Rental.js"></script>
</body>
</html>
